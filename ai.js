// Simple AI request using Groq with customizable model selection
require('dotenv').config();
const { Groq } = require('groq-sdk');

// Initialize the Groq client with API key from .env
const groq = new Groq({
  apiKey: process.env.GROQ_API_KEY,
});

async function makeGroqRequest(prompt, model = 'deepseek-r1-distill-qwen-32b') {
  try {
    console.log(`Sending request to Groq API using model: ${model}...`);
    
    const chatCompletion = await groq.chat.completions.create({
      messages: [
        {
          role: 'user',
          content: prompt,
        },
      ],
      model: model,
    });

    console.log('Response received!');
    return chatCompletion.choices[0]?.message?.content || 'No response received';
  } catch (error) {
    console.error('Error making Groq API request:', error);
    return `Error: ${error.message}`;
  }
}

/**
 * Analyzes a message and returns relevant emojis using Groq AI
 * @param {string} messageContent - The content of the message to analyze
 * @param {number} maxEmojis - Maximum number of emojis to return (default: 5)
 * @param {string} model - The Groq model to use
 * @returns {Promise<string[]>} - Array of emoji characters
 */
async function getRelevantEmojis(messageContent, maxEmojis = 5, model = 'deepseek-r1-distill-qwen-32b') {
  try {
    console.log(`Analyzing message for emoji reactions using ${model}...`);
    
    // List of common, well-supported Discord emojis
    // Keeping this list for potential future use but not using it for filtering now
    const safeEmojis = [
      'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Š', 
      'ğŸ˜‡', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ˜', 'ğŸ¤‘',
      'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„',
      'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®',
      'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜•',
      'ğŸ˜Ÿ', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°',
      'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜', 'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤',
      'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ’€', 'â˜ ï¸', 'ğŸ’©', 'ğŸ¤¡', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ‘»',
      'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾',
      'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ’‹', 'ğŸ’Œ', 'ğŸ’˜', 'ğŸ’', 'ğŸ’–', 'ğŸ’—', 'ğŸ’“', 'ğŸ’', 'ğŸ’•',
      'ğŸ’Ÿ', 'â£ï¸', 'ğŸ’”', 'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ¤', 'ğŸ–¤', 'ğŸ¤',
      'ğŸ’¯', 'ğŸ’¢', 'ğŸ’¥', 'ğŸ’«', 'ğŸ’¦', 'ğŸ’¨', 'ğŸ•³ï¸', 'ğŸ’£', 'ğŸ’¬', 'ğŸ‘ï¸â€ğŸ—¨ï¸', 'ğŸ—¨ï¸', 'ğŸ—¯ï¸',
      'ğŸ’­', 'ğŸ’¤', 'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤',
      'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 'âœŠ',
      'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸', 'ğŸ’…', 'ğŸ¤³',
      'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦¿', 'ğŸ¦µ', 'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ«€', 'ğŸ«', 'ğŸ¦·',
      'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ’‹', 'ğŸ©¸', 'ğŸ®', 'ğŸ¯', 'ğŸ²', 'ğŸ§©', 'ğŸ­',
      'ğŸ¨', 'ğŸ¬', 'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸ¹', 'ğŸ¥', 'ğŸ·', 'ğŸº', 'ğŸ¸', 'ğŸ»', 'ğŸª•',
      'ğŸ¾', 'ğŸˆ', 'âš½', 'ğŸ€', 'âš¾', 'ğŸ¥', 'ğŸ', 'ğŸ‰', 'ğŸ±', 'ğŸ“', 'ğŸ¸', 'ğŸ’',
      'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸªƒ', 'ğŸ¥…', 'â›³', 'ğŸª', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹',
      'ğŸ½', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ›·', 'â›¸ï¸', 'ğŸ¥Œ', 'ğŸ¿', 'â›·ï¸', 'ğŸ‚', 'ğŸª‚', 'ğŸ‹ï¸', 'ğŸ¤¼',
      'ğŸ¤¸', 'â›¹ï¸', 'ğŸ¤º', 'ğŸ¤¾', 'ğŸŒï¸', 'ğŸ‡', 'ğŸ§˜', 'ğŸ„', 'ğŸŠ', 'ğŸ¤½', 'ğŸš£', 'ğŸ§—',
      'ğŸšµ', 'ğŸš´', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ…', 'ğŸ–ï¸', 'ğŸµï¸', 'ğŸ—ï¸', 'ğŸ«', 'ğŸŸï¸',
      'ğŸª', 'ğŸ­', 'ğŸ¨', 'ğŸ¬', 'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸ¹', 'ğŸ¥', 'ğŸ·', 'ğŸº', 'ğŸ¸',
      'ğŸ»', 'ğŸª•', 'ğŸ²', 'â™Ÿï¸', 'ğŸ¯', 'ğŸ³', 'ğŸ®', 'ğŸ°', 'ğŸ§©', 'ğŸš—', 'ğŸš•', 'ğŸš™',
      'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸ›»', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸ¦¯',
      'ğŸ¦½', 'ğŸ¦¼', 'ğŸ›´', 'ğŸš²', 'ğŸ›µ', 'ğŸï¸', 'ğŸ›º', 'ğŸš¨', 'ğŸš”', 'ğŸš', 'ğŸš˜', 'ğŸš–',
      'ğŸš¡', 'ğŸš ', 'ğŸšŸ', 'ğŸšƒ', 'ğŸš‹', 'ğŸš', 'ğŸš', 'ğŸš„', 'ğŸš…', 'ğŸšˆ', 'ğŸš‚', 'ğŸš†',
      'ğŸš‡', 'ğŸšŠ', 'ğŸš‰', 'âœˆï¸', 'ğŸ›«', 'ğŸ›¬', 'ğŸ›©ï¸', 'ğŸ’º', 'ğŸ›°ï¸', 'ğŸš€', 'ğŸ›¸', 'ğŸš',
      'ğŸ›¶', 'â›µ', 'ğŸš¤', 'ğŸ›¥ï¸', 'ğŸ›³ï¸', 'â›´ï¸', 'ğŸš¢', 'âš“', 'ğŸš§', 'â›½', 'ğŸš', 'ğŸš¦',
      'ğŸš¥', 'ğŸ—¿', 'ğŸ—½', 'ğŸ—¼', 'ğŸ°', 'ğŸ¯', 'ğŸŸï¸', 'ğŸ¡', 'ğŸ¢', 'ğŸ ', 'â›²', 'â›±ï¸',
      'ğŸ–ï¸', 'ğŸï¸', 'ğŸœï¸', 'ğŸŒ‹', 'â›°ï¸', 'ğŸ”ï¸', 'ğŸ—»', 'ğŸ•ï¸', 'â›º', 'ğŸ ', 'ğŸ¡', 'ğŸ˜ï¸',
      'ğŸšï¸', 'ğŸ—ï¸', 'ğŸ¢', 'ğŸ­', 'ğŸ¬', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ¨', 'ğŸª', 'ğŸ«',
      'ğŸ©', 'ğŸ’’', 'ğŸ›ï¸', 'â›ª', 'ğŸ•Œ', 'ğŸ•', 'ğŸ›•', 'ğŸ•‹', 'â›©ï¸', 'ğŸ›¤ï¸', 'ğŸ›£ï¸', 'ğŸ—¾',
      'ğŸ‘', 'ğŸï¸', 'ğŸŒ…', 'ğŸŒ„', 'ğŸŒ ', 'ğŸ‡', 'ğŸ†', 'ğŸŒ‡', 'ğŸŒ†', 'ğŸ™ï¸', 'ğŸŒƒ', 'ğŸŒŒ',
      'ğŸŒ‰', 'ğŸŒ', 'âŒš', 'ğŸ“±', 'ğŸ“²', 'ğŸ’»', 'âŒ¨ï¸', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'ğŸ–±ï¸', 'ğŸ–²ï¸', 'ğŸ•¹ï¸',
      'ğŸ—œï¸', 'ğŸ’½', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“€', 'ğŸ“¼', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ¥', 'ğŸ“½ï¸', 'ğŸï¸',
      'ğŸ“', 'â˜ï¸', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ“º', 'ğŸ“»', 'ğŸ™ï¸', 'ğŸšï¸', 'ğŸ›ï¸', 'ğŸ§­', 'â±ï¸', 'â²ï¸',
      'â°', 'ğŸ•°ï¸', 'âŒ›', 'â³', 'ğŸ“¡', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ•¯ï¸', 'ğŸª”', 'ğŸ§¯',
      'ğŸ›¢ï¸', 'ğŸ’¸', 'ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·', 'ğŸª™', 'ğŸ’°', 'ğŸ’³', 'ğŸ’', 'âš–ï¸', 'ğŸªœ',
      'ğŸ§°', 'ğŸª›', 'ğŸ”§', 'ğŸ”¨', 'âš’ï¸', 'ğŸ› ï¸', 'ğŸ§²', 'ğŸ”©', 'âš™ï¸', 'ğŸ§±', 'âš’ï¸', 'ğŸ§ª',
      'ğŸ§«', 'ğŸ§¬', 'ğŸ”¬', 'ğŸ”­', 'ğŸ“¡', 'ğŸ’‰', 'ğŸ©¸', 'ğŸ’Š', 'ğŸ©¹', 'ğŸ©º', 'ğŸšª', 'ğŸ›—',
      'ğŸª', 'ğŸªŸ', 'ğŸ›ï¸', 'ğŸ›‹ï¸', 'ğŸª‘', 'ğŸš½', 'ğŸª ', 'ğŸš¿', 'ğŸ›', 'ğŸª¤', 'ğŸª’', 'ğŸ§´',
      'ğŸ§·', 'ğŸ§¹', 'ğŸ§º', 'ğŸ§»', 'ğŸª£', 'ğŸ§¼', 'ğŸª¥', 'ğŸ§½', 'ğŸ§¯', 'ğŸ›’', 'ğŸš¬', 'âš°ï¸',
      'ğŸª¦', 'âš±ï¸', 'ğŸ—¿', 'ğŸª§', 'ğŸ§', 'ğŸš®', 'ğŸš°', 'â™¿', 'ğŸš¹', 'ğŸšº', 'ğŸš»', 'ğŸš¼',
      'ğŸš¾', 'ğŸ›‚', 'ğŸ›ƒ', 'ğŸ›„', 'ğŸ›…', 'âš ï¸', 'ğŸš¸', 'â›”', 'ğŸš«', 'ğŸš³', 'ğŸš­', 'ğŸš¯',
      'ğŸš±', 'ğŸš·', 'ğŸ“µ', 'ğŸ”', 'â˜¢ï¸', 'â˜£ï¸', 'â¬†ï¸', 'â†—ï¸', 'â¡ï¸', 'â†˜ï¸', 'â¬‡ï¸', 'â†™ï¸',
      'â¬…ï¸', 'â†–ï¸', 'â†•ï¸', 'â†”ï¸', 'â†©ï¸', 'â†ªï¸', 'â¤´ï¸', 'â¤µï¸', 'ğŸ”ƒ', 'ğŸ”„', 'ğŸ”™', 'ğŸ”š',
      'ğŸ”›', 'ğŸ”œ', 'ğŸ”', 'ğŸ›', 'âš›ï¸', 'ğŸ•‰ï¸', 'âœ¡ï¸', 'â˜¸ï¸', 'â˜¯ï¸', 'âœï¸', 'â˜¦ï¸', 'â˜ªï¸',
      'â˜®ï¸', 'ğŸ•', 'ğŸ”¯', 'â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™', 'â™', 'â™‘',
      'â™’', 'â™“', 'â›', 'ğŸ”€', 'ğŸ”', 'ğŸ”‚', 'â–¶ï¸', 'â©', 'â­ï¸', 'â¯ï¸', 'â—€ï¸', 'âª', 'â®ï¸',
      'ğŸ”¼', 'â«', 'ğŸ”½', 'â¬', 'â¸ï¸', 'â¹ï¸', 'âºï¸', 'âï¸', 'ğŸ¦', 'ğŸ”…', 'ğŸ”†', 'ğŸ“¶',
      'ğŸ“³', 'ğŸ“´', 'â™€ï¸', 'â™‚ï¸', 'âš§ï¸', 'âœ–ï¸', 'â•', 'â–', 'â—', 'â™¾ï¸', 'â€¼ï¸', 'â‰ï¸',
      'â“', 'â”', 'â•', 'â—', 'ã€°ï¸', 'ğŸ’±', 'ğŸ’²', 'âš•ï¸', 'â™»ï¸', 'âšœï¸', 'ğŸ”±', 'ğŸ“›',
      'ğŸ”°', 'â­•', 'âœ…', 'â˜‘ï¸', 'âœ”ï¸', 'âŒ', 'â', 'â°', 'â¿', 'ã€½ï¸', 'âœ³ï¸', 'âœ´ï¸',
      'â‡ï¸', 'Â©ï¸', 'Â®ï¸', 'â„¢ï¸', '#ï¸âƒ£', '*ï¸âƒ£', '0ï¸âƒ£', '1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£',
      '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ', 'ğŸ” ', 'ğŸ”¡', 'ğŸ”¢', 'ğŸ”£', 'ğŸ”¤',
      'ğŸ…°ï¸', 'ğŸ†', 'ğŸ…±ï¸', 'ğŸ†‘', 'ğŸ†’', 'ğŸ†“', 'â„¹ï¸', 'ğŸ†”', 'â“‚ï¸', 'ğŸ†•', 'ğŸ†–', 'ğŸ…¾ï¸',
      'ğŸ†—', 'ğŸ…¿ï¸', 'ğŸ†˜', 'ğŸ†™', 'ğŸ†š', 'ğŸˆ', 'ğŸˆ‚ï¸', 'ğŸˆ·ï¸', 'ğŸˆ¶', 'ğŸˆ¯', 'ğŸ‰', 'ğŸˆ¹',
      'ğŸˆš', 'ğŸˆ²', 'ğŸ‰‘', 'ğŸˆ¸', 'ğŸˆ´', 'ğŸˆ³', 'ãŠ—ï¸', 'ãŠ™ï¸', 'ğŸˆº', 'ğŸˆµ', 'ğŸ”´', 'ğŸŸ ',
      'ğŸŸ¡', 'ğŸŸ¢', 'ğŸ”µ', 'ğŸŸ£', 'ğŸŸ¤', 'âš«', 'âšª', 'ğŸŸ¥', 'ğŸŸ§', 'ğŸŸ¨', 'ğŸŸ©', 'ğŸŸ¦',
      'ğŸŸª', 'ğŸŸ«', 'â¬›', 'â¬œ', 'â—¼ï¸', 'â—»ï¸', 'â—¾', 'â—½', 'â–ªï¸', 'â–«ï¸', 'ğŸ”¶', 'ğŸ”·',
      'ğŸ”¸', 'ğŸ”¹', 'ğŸ”º', 'ğŸ”»', 'ğŸ’ ', 'ğŸ”˜', 'ğŸ”³', 'ğŸ”²', 'ğŸ', 'ğŸš©', 'ğŸŒ', 'ğŸ´',
      'ğŸ³ï¸', 'ğŸ³ï¸â€ğŸŒˆ', 'ğŸ³ï¸â€âš§ï¸', 'ğŸ´â€â˜ ï¸'
    ];
    
    const prompt = `
Analyze this message and suggest ${maxEmojis} relevant emojis that would be appropriate reactions:
"${messageContent}"

Return ONLY the emoji characters with no explanation, separated by spaces. 
For example: "ğŸ˜Š ğŸ‘ ğŸ‰ ğŸ¤” â¤ï¸"

Important: Only use standard Unicode emojis that are widely supported in all platforms.
`;
    
    const chatCompletion = await groq.chat.completions.create({
      messages: [
        {
          role: 'system',
          content: 'You are a helpful assistant that analyzes message content and returns only relevant emoji characters. No text explanations, just emojis separated by spaces.',
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      model: model,
      temperature: 0.3, // Lower temperature for more predictable results
    });

    const response = chatCompletion.choices[0]?.message?.content || '';
    
    // Remove any <think>...</think> blocks from the response
    const cleanedResponse = response.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
    console.log('Raw emoji response:', cleanedResponse);
    
    // Extract only emoji characters from the cleaned response
    const emojiRegex = /[\p{Emoji}]/gu;
    let emojis = [...cleanedResponse.matchAll(emojiRegex)].map(match => match[0]);
    
    // No longer filtering through safeEmojis
    // emojis = emojis.filter(emoji => safeEmojis.includes(emoji));
    
    // Limit to maxEmojis
    const limitedEmojis = emojis.slice(0, maxEmojis);
    
    console.log('Extracted emojis:', limitedEmojis);
    return limitedEmojis;
  } catch (error) {
    console.error('Error getting emoji suggestions:', error);
    return []; // Return empty array instead of default emojis
  }
}

/**
 * Validates if an emoji is supported by Discord
 * @param {string} emoji - The emoji to validate
 * @returns {boolean} - Whether the emoji is valid
 */
function isValidDiscordEmoji(emoji) {
  // Basic validation - ensure it's a single character emoji
  return emoji && emoji.length === 1 || emoji.length === 2 && /\p{Emoji}/u.test(emoji);
}

// Display usage information if --help flag is provided
if (process.argv.includes('--help')) {
  console.log(`
Usage: node ai.js [prompt] [--model=MODEL_NAME]

Arguments:
  prompt             The prompt to send to the AI (in quotes)
  --model=MODEL_NAME The Groq model to use (default: deepseek-r1-distill-qwen-32b)

Examples:
  node ai.js "What is the capital of France?"
  node ai.js "Explain quantum computing" --model=llama3-70b-8192
  `);
  process.exit(0);
}

// Parse command line arguments
let userPrompt = 'Explain quantum computing in simple terms.';
let model = 'deepseek-r1-distill-qwen-32b';

// Get the prompt (first non-flag argument)
const nonFlagArgs = process.argv.slice(2).filter(arg => !arg.startsWith('--'));
if (nonFlagArgs.length > 0) {
  userPrompt = nonFlagArgs[0];
}

// Check for model flag
const modelArg = process.argv.find(arg => arg.startsWith('--model='));
if (modelArg) {
  model = modelArg.split('=')[1];
}

// Run the request if script is called directly
if (require.main === module) {
  makeGroqRequest(userPrompt, model)
    .then(response => {
      console.log('\nPrompt:', userPrompt);
      console.log('\nResponse:', response);
    })
    .catch(error => {
      console.error('Error:', error);
    });
}

// Export the functions for use in other files
module.exports = { 
  makeGroqRequest,
  getRelevantEmojis,
  isValidDiscordEmoji
};
